#!/bin/bash
# Pre-commit hook to ensure all files under */lib/* are symlinks
# Install: cp bin/pre-commit-hook .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Find git root
GIT_ROOT=$(git rev-parse --show-toplevel)

echo "Checking that all files under arduino_goofin/*/lib/* are symlinks..."

# Find all files under arduino_goofin/*/lib/* that are being committed
# Exclude circuitpython_firmware/ which contains the actual bundle files
non_symlinks=$(git diff --cached --name-only --diff-filter=ACM | grep '^arduino_goofin/.*/lib/' | grep -v '^arduino_goofin/circuitpython_firmware/' | while read file; do
    filepath="$GIT_ROOT/$file"
    if [ -f "$filepath" ] && [ ! -L "$filepath" ]; then
        echo "$file"
    fi
done)

if [ -n "$non_symlinks" ]; then
    echo "ERROR: Found non-symlink files under arduino_goofin/*/lib/* directories:"
    echo "$non_symlinks"
    echo ""
    echo "All files under arduino_goofin/*/lib/* must be symlinks to the central bundle."
    echo "Please replace these files with symlinks to adafruit-circuitpython-bundle-*/lib/"
    exit 1
fi

echo "âœ“ All arduino_goofin/*/lib/* files are symlinks"
exit 0
